#!/usr/bin/env bash

# brain-dump: Inspect dump contents with JSON support
# Subcommands: ls (with optional --json flag)

set -euo pipefail

# Resolve script directory to find library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Locate and source libraries
if [[ -f "$(dirname "$SCRIPT_DIR")/lib/brain-config.sh" ]]; then
  # 1. Dev/Repo location (flat lib/)
  source "$(dirname "$SCRIPT_DIR")/lib/brain-config.sh"
elif [[ -f "$(dirname "$SCRIPT_DIR")/lib/brain/brain-config.sh" ]]; then
  # 2. System install (PREFIX/lib/brain/)
  source "$(dirname "$SCRIPT_DIR")/lib/brain/brain-config.sh"
elif [[ -f "$HOME/.config/brain/lib/brain-config.sh" ]]; then
  # 3. User config location (Fallback)
  source "$HOME/.config/brain/lib/brain-config.sh"
else
  echo "Error: brain-config.sh library not found." >&2
  exit 1
fi

# Source API library
if [[ -f "$(dirname "$SCRIPT_DIR")/lib/brain-api.sh" ]]; then
  source "$(dirname "$SCRIPT_DIR")/lib/brain-api.sh"
elif [[ -f "$(dirname "$SCRIPT_DIR")/lib/brain/brain-api.sh" ]]; then
  source "$(dirname "$SCRIPT_DIR")/lib/brain/brain-api.sh"
elif [[ -f "$HOME/.config/brain/lib/brain-api.sh" ]]; then
  source "$HOME/.config/brain/lib/brain-api.sh"
else
  echo "Error: brain-api.sh library not found." >&2
  exit 1
fi

show_help() {
  cat << 'EOF'
brain-dump - Inspect dump contents

Usage:
  brain dump ls           List items (human-readable)
  brain dump ls --json    List items (machine-readable)

Examples:
  brain dump ls
  brain dump ls --json | jq '.[] | select(.type=="todo")'
  brain dump ls --json | jq -r '.[].id'

Output (human-readable):
  ID      | Type | Content
  --------+------+------------------------------------------
  a1b2c3  | TODO | Fix broken login button
  d4e5f6  | NOTE | Meeting notes: discussed new feature

Output (JSON):
  [
    {
      "id": "a1b2c3",
      "content": "Fix broken login button",
      "raw": "- [ ] Fix broken login button #captured:2026-01-09",
      "type": "todo",
      "timestamp": "2026-01-09"
    }
  ]
EOF
}

cmd_ls() {
  local json_mode=false
  [[ "${1:-}" == "--json" ]] && json_mode=true

  local inbox=$(get_current_brain_path)/00_dump.md

  if [[ ! -f "$inbox" ]]; then
    if [[ "$json_mode" == "true" ]]; then
      echo "[]"
    else
      echo "Error: Dump not found at $inbox" >&2
    fi
    exit 1
  fi

  if [[ "$json_mode" == "true" ]]; then
    parse_dump_items "$inbox" | dump_to_json
  else
    # Human-readable table
    printf "%-8s | %-6s | %s\n" "ID" "Type" "Content"
    printf "%s\n" "--------+------+----------"

    local count=0
    parse_dump_items "$inbox" | while IFS='|' read -r start_line end_line type title id; do
      # Strip captured tag for display
      local content="$title"
      content=$(echo "$content" | sed -E 's/ #captured:[0-9-]+$//')

      # Indicate multi-line notes
      local lines=$((end_line - start_line + 1))
      local suffix=""
      [[ "$type" == "note" ]] && [[ $lines -gt 1 ]] && suffix=" (${lines} lines)"

      printf "%-8s | %-6s | %s%s\n" "$id" "$type" "$content" "$suffix"
      count=$((count + 1))
    done

    # Show count if items exist
    if [[ $count -eq 0 ]]; then
      echo "(No items in dump)"
    fi
  fi
}

main() {
  case "${1:-}" in
    ls|list) shift; cmd_ls "$@" ;;
    --help|-h|help|"") show_help; exit 0 ;;
    *) echo "Error: Unknown subcommand '$1'" >&2; show_help; exit 2 ;;
  esac
}

main "$@"
