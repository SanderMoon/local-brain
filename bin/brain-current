#!/usr/bin/env bash

# brain-current: Show current active brain

set -euo pipefail

# Source config library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Locate and source library
if [[ -f "$(dirname "$SCRIPT_DIR")/lib/brain-config.sh" ]]; then
    # 1. Dev/Repo location
    source "$(dirname "$SCRIPT_DIR")/lib/brain-config.sh"
elif [[ -f "$(dirname "$SCRIPT_DIR")/../lib/brain/brain-config.sh" ]]; then
    # 2. System install (via Makefile)
    source "$(dirname "$SCRIPT_DIR")/../lib/brain/brain-config.sh"
elif [[ -f "$HOME/.config/brain/lib/brain-config.sh" ]]; then
    # 3. User config location
    source "$HOME/.config/brain/lib/brain-config.sh"
else
    echo "Error: brain-config.sh library not found." >&2
    exit 1
fi

BRAIN_PATH=$(get_current_brain_path)

show_help() {
    cat << 'EOF'
brain-current - Show current active brain

Usage:
  brain current [options]

Options:
  --name-only          Output only the brain name
  --path-only          Output only the path
  --help, -h           Show this help

Examples:
  brain current              # Show name and path
  brain current --name-only  # Just the name
  brain current --path-only  # Just the path
EOF
}

# Parse arguments
NAME_ONLY=false
PATH_ONLY=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        --help|-h)
            show_help
            exit 0
            ;;
        --name-only)
            NAME_ONLY=true
            shift
            ;;
        --path-only)
            PATH_ONLY=true
            shift
            ;;
        *)
            echo "Error: Unknown argument '$1'"
            exit 1
            ;;
    esac
done

# Get current brain
current=$(get_current_brain)

if [[ -z "$current" ]]; then
    echo "No brain currently active"
    echo ""
    echo "Initialize a brain:"
    echo "  brain init"
    exit 1
fi

path=$(get_brain_path "$current")

# Output based on flags
if $NAME_ONLY; then
    echo "$current"
elif $PATH_ONLY; then
    echo "$path"
else
    echo "Current brain: $current"
    echo "Location: $path"
fi
