#!/usr/bin/env bash

# brain-import: Scan and register existing brains
# Usage: brain import [path]

set -euo pipefail

# Source config library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Locate and source library
if [[ -f "$(dirname "$SCRIPT_DIR")/lib/brain-config.sh" ]]; then
    source "$(dirname "$SCRIPT_DIR")/lib/brain-config.sh"
elif [[ -f "$(dirname "$SCRIPT_DIR")/lib/brain/brain-config.sh" ]]; then
    source "$(dirname "$SCRIPT_DIR")/lib/brain/brain-config.sh"
elif [[ -f "$HOME/.config/brain/lib/brain-config.sh" ]]; then
    source "$HOME/.config/brain/lib/brain-config.sh"
else
    echo "Error: brain-config.sh library not found." >&2
    exit 1
fi

show_help() {
    cat << 'EOF'
brain-import - Import existing brains

Usage:
  brain import [root-path]

  Scans the directory (default: ~/brains) for brain structures
  and registers them in the local configuration.

Examples:
  brain import            # Scan ~/brains
  brain import ~/Dropbox/Brains
EOF
}

# Check args
if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    show_help
    exit 0
fi

# Determine root to scan
SCAN_ROOT="${1:-${BRAIN_ROOT:-$HOME/brains}}"

if [[ ! -d "$SCAN_ROOT" ]]; then
    echo "Error: Directory '$SCAN_ROOT' not found."
    exit 1
fi

echo "Scanning '$SCAN_ROOT' for brains..."
echo ""

IMPORTED_COUNT=0

# Iterate directories
for brain_dir in "$SCAN_ROOT"/*; do
    if [[ ! -d "$brain_dir" ]]; then continue; fi
    
    BRAIN_NAME=$(basename "$brain_dir")
    
    # Validation: Look for signature files
    if [[ -d "$brain_dir/01_active" ]] && [[ -f "$brain_dir/00_dump.md" ]]; then
        
        # Check if already registered
        if brain_exists "$BRAIN_NAME"; then
            CURRENT_PATH=$(get_brain_path "$BRAIN_NAME")
            if [[ "$CURRENT_PATH" == "$brain_dir" ]]; then
                echo " [Skip] '$BRAIN_NAME' already registered."
            else
                echo " [Skip] '$BRAIN_NAME' exists but points to different path ($CURRENT_PATH)."
            fi
        else
            # Register it
            add_brain "$BRAIN_NAME" "$brain_dir"
            echo " [OK]   Imported '$BRAIN_NAME'"
            IMPORTED_COUNT=$((IMPORTED_COUNT + 1))
        fi
    fi
done

echo ""
if [[ $IMPORTED_COUNT -eq 0 ]]; then
    echo "No new brains found."
else
    echo "Successfully imported $IMPORTED_COUNT brain(s)."
    echo "Use 'brain list' to view them."
    
    # Auto-switch if no current brain set
    if [[ -z "$(get_current_brain)" ]]; then
        echo "Setting '$BRAIN_NAME' as active brain..."
        set_current_brain "$BRAIN_NAME"
    fi
fi
