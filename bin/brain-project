#!/usr/bin/env bash

# brain-project: Project management commands
# Subcommands: new, list, select, current, link, pull, archive, move

set -euo pipefail

# Source config library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Locate and source library
if [[ -f "$(dirname "$SCRIPT_DIR")/lib/brain-config.sh" ]]; then
  # 1. Dev/Repo location (flat lib/)
  source "$(dirname "$SCRIPT_DIR")/lib/brain-config.sh"
elif [[ -f "$(dirname "$SCRIPT_DIR")/lib/brain/brain-config.sh" ]]; then
  # 2. System install (PREFIX/lib/brain/)
  source "$(dirname "$SCRIPT_DIR")/lib/brain/brain-config.sh"
elif [[ -f "$HOME/.config/brain/lib/brain-config.sh" ]]; then
  # 3. User config location (Fallback)
  source "$HOME/.config/brain/lib/brain-config.sh"
else
  echo "Error: brain-config.sh library not found." >&2
  exit 1
fi

BRAIN_PATH=$(get_current_brain_path)
BRAIN_DIR="$BRAIN_PATH"
ACTIVE_DIR="$BRAIN_DIR/01_active"
ARCHIVE_DIR="$BRAIN_DIR/99_archive"
DEV_DIR="$HOME/dev"

show_help() {
  cat << 'EOF'
brain-project - Project management

Usage:
 brain project list [ls]        List active projects
 brain project select <name>      Focus on a project for subsequent commands
 brain project current         Show currently focused project
   brain project new <name>              Create a new project
   brain project clone <url> [name]      Import a git repository as a project
   brain project move <name> <brain>     Move project to another brain
 brain project delete <name>      Permanently delete a project
 brain project link <git-url>     Link a git repository
 brain project pull          Clone/update linked repositories
 brain project archive <name>     Archive a project

Examples:
  brain project list
  brain project clone https://github.com/user/app.git
  brain project delete my-app           # Permanently delete 'my-app'
EOF
}

# Helper: Resolve target project (PWD -> Focus -> Interactive)
# Returns: "project_name" or exits with error
resolve_target_project() {
  local action_desc="$1" # e.g. "link repository"
  local current_dir="$(pwd)"
  
  # 1. Check PWD
  if [[ "$current_dir" == "$ACTIVE_DIR"/* ]]; then
    basename "$current_dir"
    return 0
  fi
  
  # 2. Check Focused Project
  local focused=$(get_focused_project)
  if [[ -n "$focused" ]] && [[ -d "$ACTIVE_DIR/$focused" ]]; then
    echo "$focused"
    return 0
  fi
  
  # 3. Interactive Selection
  if ! command -v fzf &> /dev/null; then
    echo "Error: Cannot resolve project." >&2
    echo "Install fzf for interactive selection or use 'brain project select <name>'" >&2
    exit 1
  fi
  
  local project=$(find "$ACTIVE_DIR" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; |
    fzf --header="Select project to $action_desc" --prompt="Project> " || true)
    
  if [[ -z "$project" ]]; then
    echo "No project selected." >&2
    exit 1
  fi
  
  echo "$project"
}

# List projects
cmd_list() {
  # Check for --json flag
  local json_mode=false
  if [[ "${1:-}" == "--json" ]]; then
    json_mode=true
    # Source API library
    if [[ -f "$(dirname "$SCRIPT_DIR")/lib/brain-api.sh" ]]; then
      source "$(dirname "$SCRIPT_DIR")/lib/brain-api.sh"
    elif [[ -f "$(dirname "$SCRIPT_DIR")/lib/brain/brain-api.sh" ]]; then
      source "$(dirname "$SCRIPT_DIR")/lib/brain/brain-api.sh"
    elif [[ -f "$HOME/.config/brain/lib/brain-api.sh" ]]; then
      source "$HOME/.config/brain/lib/brain-api.sh"
    fi
  fi

  if [[ "$json_mode" == "true" ]]; then
    projects_to_json "$ACTIVE_DIR"
    return 0
  fi

  # Existing human-readable output
  local focused=$(get_focused_project)

  echo "Active Projects:"
  echo "----------------"

  if [[ ! -d "$ACTIVE_DIR" ]] || [[ -z "$(ls -A "$ACTIVE_DIR")" ]]; then
    echo "(No active projects)"
    return 0
  fi

  for proj_path in "$ACTIVE_DIR"/*; do
    if [[ -d "$proj_path" ]]; then
      local name=$(basename "$proj_path")
      local marker=" "
      local status=""

      if [[ "$name" == "$focused" ]]; then
        marker="*"
        status="(selected)"
      fi

      # Simple stats
      local repo_count=$(grep -vc "^#" "$proj_path/.repos" 2>/dev/null || echo "0")
      local task_count=$(grep -c "^\s*- \[ \]" "$proj_path/todo.md" 2>/dev/null || echo "0")

      printf " %s %-20s %s\n" "$marker" "$name" "$status [Repos: $repo_count, Tasks: $task_count]"
    fi
  done
  echo ""
}

# Select project
cmd_select() {
  local name="${1:-""}"
  
  # If no name provided, use interactive selection
  if [[ -z "$name" ]]; then
    name=$(find "$ACTIVE_DIR" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; |
      fzf --header="Select project to focus" || true)
    if [[ -z "$name" ]]; then exit 0; fi
  fi
  
  if [[ ! -d "$ACTIVE_DIR/$name" ]]; then
    echo "Error: Project '$name' not found."
    exit 1
  fi
  
  set_focused_project "$name"
  echo "OK: Selected project: $name"
}

# Show current project
cmd_current() {
  local focused=$(get_focused_project)
  if [[ -n "$focused" ]]; then
    echo "$focused"
  else
    echo "No project selected."
    exit 1
  fi
}

# Create a new project
cmd_new() {
  local project_name="$1"

  if [[ -z "$project_name" ]]; then
    echo "Error: Project name required"
    echo "Usage: brain project new <name>"
    exit 1
  fi

  # Validate project name
  if [[ ! "$project_name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    echo "Error: Project name can only contain letters, numbers, hyphens, and underscores"
    exit 1
  fi

  local project_dir="$ACTIVE_DIR/$project_name"

  if [[ -d "$project_dir" ]]; then
    echo "Error: Project '$project_name' already exists"
    exit 1
  fi

  # Create project directory
  mkdir -p "$project_dir"
  cat > "$project_dir/notes.md" << EOF
# $project_name
Created: $(date +"%Y-%m-%d")
## Overview
[Description]
## Notes
EOF
  cat > "$project_dir/todo.md" << EOF
# Tasks
## Active
- [ ] Define project goals
- [ ] Set up development environment
## Completed
EOF
  touch "$project_dir/.repos"

  echo "OK: Created project: $project_name"
  
  # Auto-select the new project
  set_focused_project "$project_name"
  echo "OK: Selected project: $project_name"
}

# Clone a git repo as a new project
cmd_clone() {
    local git_url="$1"
    local project_name="${2:-}"

    if [[ -z "$git_url" ]]; then
        echo "Error: Git URL required"
        echo "Usage: brain project clone <url> [name]"
        exit 1
    fi

    if [[ -z "$project_name" ]]; then
        # Improved regex to handle trailing slashes and .git
        local url_clean="${git_url%/}"
        url_clean="${url_clean%.git}"
        project_name=$(basename "$url_clean")
        
        if [[ -z "$project_name" ]]; then
            echo "Error: Could not determine project name from URL."
            exit 1
        fi
    fi

    echo "ðŸš€ Importing '$project_name'..."

    # 1. New project
    cmd_new "$project_name"

    # 2. Link
    cmd_link "$git_url"

    # 3. Pull
    cmd_pull

    echo ""
    echo "âœ¨ Import complete!"
    echo "Current project focused: $project_name"
    echo "Ready to go? Type: brain go"
}

# Link a git repository
cmd_link() {
  local git_url="$1"

  if [[ -z "$git_url" ]]; then
    echo "Error: Git URL required"
    exit 1
  fi

  local project=$(resolve_target_project "link repository")
  local repos_file="$ACTIVE_DIR/$project/.repos"

  # Validate remote
  echo "Verifying repository..."
  if ! git ls-remote "$git_url" HEAD &> /dev/null; then
    echo "Warning: Could not verify repository."
    read -p "Link anyway? [y/N]: " link_anyway
    if [[ ! "$link_anyway" =~ ^[Yy] ]]; then
      echo "Aborted"
      exit 1
    fi
  fi

  # Check duplicate
  if [[ -f "$repos_file" ]] && grep -Fxq "$git_url" "$repos_file"; then
    echo "Repository already linked to $project"
    exit 0
  fi

  echo "$git_url" >> "$repos_file"
  echo "OK: Linked to $project: $git_url"
  echo "Run 'brain project pull' to clone."
}

# Pull all linked repositories
cmd_pull() {
  local project=$(resolve_target_project "pull repositories")
  local repos_file="$ACTIVE_DIR/$project/.repos"
  
  echo "Project: $project"
  
  # Ensure dev directory exists
  mkdir -p "$DEV_DIR"

  if [[ ! -s "$repos_file" ]]; then
    echo "No repositories linked."
    exit 0
  fi

  while IFS= read -r git_url; do
    [[ -z "$git_url" ]] && continue
    [[ "$git_url" =~ ^# ]] && continue

    local repo_name
    if [[ "$git_url" =~ /([^/]+)\.git$ ]]; then repo_name="${BASH_REMATCH[1]}"
    elif [[ "$git_url" =~ /([^/]+)$ ]]; then repo_name="${BASH_REMATCH[1]}"
    elif [[ "$git_url" =~ :([^/]+)\.git$ ]]; then repo_name="${BASH_REMATCH[1]}"
    else continue; fi

    local repo_path="$DEV_DIR/$repo_name"
    echo " $repo_name "

    if [[ -d "$repo_path" ]]; then
      echo "Updating..."
      git -C "$repo_path" pull || echo "ERROR: Failed update"
    else
      echo "Cloning..."
      git clone "$git_url" "$repo_path" || echo "ERROR: Failed clone"
    fi
    echo ""
  done < "$repos_file"
}

# Archive a project
cmd_archive() {
  local project_name="${1:-""}"
  
  if [[ -z "$project_name" ]]; then
    # Default to selected, but confirm
    project_name=$(get_focused_project)
    if [[ -z "$project_name" ]]; then
      echo "Usage: brain project archive <name>"
      exit 1
    fi
  fi

  local project_dir="$ACTIVE_DIR/$project_name"
  if [[ ! -d "$project_dir" ]]; then
    echo "Error: Project '$project_name' not found"
    exit 1
  fi
  
  # Check if focused, if so, clear focus
  if [[ "$project_name" == "$(get_focused_project)" ]]; then
     set_focused_project ""
  fi

  mkdir -p "$ARCHIVE_DIR"
  local timestamp=$(date +"%Y%m%d")
  local archive_name="${project_name}_${timestamp}"
  
  mv "$project_dir" "$ARCHIVE_DIR/$archive_name"
  echo "OK: Archived: $project_name"
}

# Move a project to another brain
cmd_move() {
  local project_name="$1"
  local target_brain="${2:-""}"

  if [[ -z "$project_name" ]]; then
    echo "Error: Project name required"
    exit 1
  fi
  
  # Check if target provided
  if [[ -z "$target_brain" ]]; then
    # Interactive selection of target brain
    if command -v fzf &> /dev/null; then
      target_brain=$(list_brains | grep -v "^$(get_current_brain)$
" | fzf --header="Select target brain" --prompt="Brain> ")
    fi
    
    if [[ -z "$target_brain" ]]; then
      echo "Usage: brain project move <project> <target-brain>"
      exit 1
    fi
  fi

  local current_path="$ACTIVE_DIR/$project_name"
  if [[ ! -d "$current_path" ]]; then
    echo "Error: Project '$project_name' not found in current brain"
    exit 1
  fi

  if ! brain_exists "$target_brain"; then
    echo "Error: Target brain '$target_brain' does not exist"
    exit 1
  fi
  
  local target_brain_path=$(get_brain_path "$target_brain")
  local target_path="$target_brain_path/01_active/$project_name"
  
  if [[ -d "$target_path" ]]; then
    echo "Error: Project '$project_name' already exists in '$target_brain'"
    exit 1
  fi
  
  # Move
  echo "Moving '$project_name' to '$target_brain'..."
  mv "$current_path" "$target_path"
  
  # Update focus if needed
  if [[ "$project_name" == "$(get_focused_project)" ]]; then
    set_focused_project ""
  fi
  
  echo "OK: Project moved successfully"
}

# Permanently delete a project
cmd_delete() {
  local project_name="${1:-""}"
  
  if [[ -z "$project_name" ]]; then
    # Default to selected, but confirm
    project_name=$(get_focused_project)
    if [[ -z "$project_name" ]]; then
      echo "Usage: brain project delete <name>"
      exit 1
    fi
  fi

  local project_dir="$ACTIVE_DIR/$project_name"
  if [[ ! -d "$project_dir" ]]; then
    echo "Error: Project '$project_name' not found"
    exit 1
  fi

  echo "WARNING: WARNING: You are about to PERMANENTLY DELETE project '$project_name'"
  echo "  Location: $project_dir"
  echo "  This action cannot be undone."
  echo "  Consider using 'brain project archive' instead."
  echo ""
  read -p "Are you sure you want to delete it? [y/N]: " confirm
  
  if [[ ! "$confirm" =~ ^[Yy] ]]; then
    echo "Aborted."
    exit 0
  fi
  
  # Check if focused, if so, clear focus
  if [[ "$project_name" == "$(get_focused_project)" ]]; then
     set_focused_project ""
  fi
  
  rm -rf "$project_dir"
  echo "OK: Deleted project: $project_name"
}

# Main command router
main() {
  if [[ $# -eq 0 ]] || [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]]; then
    show_help
    exit 0
  fi

  local subcommand="$1"
  shift

      case "$subcommand" in
          new) cmd_new "$@" ;; 
          clone) cmd_clone "$@" ;;
          link) cmd_link "$@" ;;    pull) cmd_pull ;; 
    archive) cmd_archive "$@" ;; 
    move) cmd_move "$@" ;; 
    delete) cmd_delete "$@" ;;
    list|ls) cmd_list "$@" ;; 
    select) cmd_select "$@" ;; 
    current) cmd_current ;; 
    *) 
      echo "Error: Unknown subcommand '$subcommand'"
      echo "Run 'brain project --help' for usage"
      exit 1
      ;; 
  esac
}

main "$@"
