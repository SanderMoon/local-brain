#!/usr/bin/env bash

# brain-init: Initialize a new brain location
# Interactive command to create and configure a new brain

set -euo pipefail

# Source config library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Locate and source library
if [[ -f "20 20 12 61 79 80 81 33 98 100 204 250 395 398 399 400 701dirname "")/lib/brain-config.sh" ]]; then
    # 1. Dev/Repo location
    source "20 20 12 61 79 80 81 33 98 100 204 250 395 398 399 400 701dirname "")/lib/brain-config.sh"
elif [[ -f "20 20 12 61 79 80 81 33 98 100 204 250 395 398 399 400 701dirname "")/../lib/brain/brain-config.sh" ]]; then
    # 2. System install (via Makefile)
    source "20 20 12 61 79 80 81 33 98 100 204 250 395 398 399 400 701dirname "")/../lib/brain/brain-config.sh"
elif [[ -f "/.config/brain/lib/brain-config.sh" ]]; then
    # 3. User config location
    source "/.config/brain/lib/brain-config.sh"
else
    echo "Error: Cannot find brain-config.sh library"
    exit 1
fi

show_help() {
    cat << 'EOF'
brain-init - Initialize a new brain

Usage:
  brain init [location] [options]

Options:
  --name <name>        Name for this brain (default: uses directory name)
  --set-current        Set as current brain immediately
  --non-interactive    Skip interactive prompts (requires location argument)
  --help, -h           Show this help

Interactive Mode:
  If no location provided, enters interactive mode to:
  - Choose brain location
  - Specify brain name
  - Set as current (optional)

Examples:
  brain init                              # Interactive mode
  brain init ~/work-brain                 # Use directory name as brain name
  brain init ~/work-brain --name work     # Specify custom name
  brain init ~/personal --set-current     # Create and switch immediately

What gets created:
  <location>/
  ├── 00_inbox.md          # Inbox for quick captures
  ├── 01_active/           # Active projects
  ├── 02_areas/            # Ongoing responsibilities
  ├── 03_resources/        # Reference material
  └── 99_archive/          # Completed projects
EOF
}

# Parse arguments
LOCATION=""
BRAIN_NAME=""
SET_CURRENT=false
INTERACTIVE=true

while [[ $# -gt 0 ]]; do
    case "$1" in
        --help|-h)
            show_help
            exit 0
            ;;
        --name)
            BRAIN_NAME="$2"
            shift 2
            ;;
        --set-current)
            SET_CURRENT=true
            shift
            ;;
        --non-interactive)
            INTERACTIVE=false
            shift
            ;;
        *)
            if [[ -z "$LOCATION" ]]; then
                LOCATION="$1"
                INTERACTIVE=false
            else
                echo "Error: Unknown argument '$1'"
                exit 1
            fi
            shift
            ;;
    esac
done

# Interactive mode
if $INTERACTIVE; then
    echo "═══════════════════════════════════════════"
    echo "  Initialize New Brain"
    echo "═══════════════════════════════════════════"
    echo ""

    # Ask for location
    echo "Where would you like to create your brain?"
    read -p "Location [~/brain]: " input_location
    LOCATION="${input_location:-$HOME/brain}"

    # Expand tilde
    LOCATION="${LOCATION/#\~/$HOME}"

    # Ask for name
    default_name=$(basename "$LOCATION")
    read -p "Brain name [$default_name]: " input_name
    BRAIN_NAME="${input_name:-$default_name}"

    # Ask if set as current
    if [[ -n "$(get_current_brain 2>/dev/null)" ]]; then
        read -p "Set as current brain? [y/N]: " set_current_input
        if [[ "$set_current_input" =~ ^[Yy] ]]; then
            SET_CURRENT=true
        fi
    else
        # No current brain, automatically set as current
        SET_CURRENT=true
        echo "→ Will set as current brain (no existing brain configured)"
    fi
fi

# Validate location
if [[ -z "$LOCATION" ]]; then
    echo "Error: Location required"
    echo "Usage: brain init <location> [--name <name>]"
    exit 1
fi

# Expand tilde
LOCATION="${LOCATION/#\~/$HOME}"

# Derive brain name if not provided
if [[ -z "$BRAIN_NAME" ]]; then
    BRAIN_NAME=$(basename "$LOCATION")
fi

# Validate brain name (alphanumeric, hyphens, underscores only)
if [[ ! "$BRAIN_NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    echo "Error: Brain name can only contain letters, numbers, hyphens, and underscores"
    exit 1
fi

# Check if brain already exists in config
if brain_exists "$BRAIN_NAME"; then
    echo "Error: Brain '$BRAIN_NAME' already exists"
    echo "Existing location: $(get_brain_path "$BRAIN_NAME")"
    echo ""
    echo "To use a different name: brain init $LOCATION --name other-name"
    echo "To switch to existing: brain switch $BRAIN_NAME"
    exit 1
fi

# Check if location already exists and is not empty
if [[ -d "$LOCATION" ]] && [[ -n "$(ls -A "$LOCATION" 2>/dev/null)" ]]; then
    echo "Warning: Directory '$LOCATION' already exists and is not empty"
    read -p "Continue anyway? [y/N]: " continue_input
    if [[ ! "$continue_input" =~ ^[Yy] ]]; then
        echo "Aborted"
        exit 1
    fi
fi

# Create directory structure
echo ""
echo "Creating brain at: $LOCATION"
mkdir -p "$LOCATION"/{01_active,02_areas,03_resources,99_archive}

# Create inbox
cat > "$LOCATION/00_inbox.md" << 'EOF'
# Inbox

Quick capture landing zone. Process with `brain refile`.

EOF

echo "✓ Created directory structure"

# Add to config
add_brain "$BRAIN_NAME" "$LOCATION"
echo "✓ Added '$BRAIN_NAME' to configuration"

# Set as current if requested
if $SET_CURRENT; then
    set_current_brain "$BRAIN_NAME"
    echo "✓ Set as current brain"
    echo "✓ Created symlink: ~/brain → $LOCATION"
fi

echo ""
echo "═══════════════════════════════════════════"
echo "Brain '$BRAIN_NAME' initialized successfully!"
echo ""
echo "Location: $LOCATION"

if $SET_CURRENT; then
    echo "Status: Active (current)"
else
    echo "Status: Configured (not active)"
    echo ""
    echo "To activate: brain switch $BRAIN_NAME"
fi

echo ""
echo "Next steps:"
echo "  brain add \"Your first task\""
echo "  brain project new my-project"
echo "  brain todo"
