#!/usr/bin/env bash

# brain-init: Initialize a new brain location
# Enforces centralized storage in ~/brains/

set -euo pipefail

# Source config library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Locate and source library
if [[ -f "$(dirname "$SCRIPT_DIR")/lib/brain-config.sh" ]]; then
    source "$(dirname "$SCRIPT_DIR")/lib/brain-config.sh"
elif [[ -f "$(dirname "$SCRIPT_DIR")/lib/brain/brain-config.sh" ]]; then
    source "$(dirname "$SCRIPT_DIR")/lib/brain/brain-config.sh"
elif [[ -f "$HOME/.config/brain/lib/brain-config.sh" ]]; then
    source "$HOME/.config/brain/lib/brain-config.sh"
else
    echo "Error: brain-config.sh library not found." >&2
    exit 1
fi

show_help() {
    cat << 'EOF'
brain-init - Initialize a new brain

Usage:
  brain init [name]

  If no name provided, defaults to 'default'.
  Brains are always created in ~/brains/<name>.

Examples:
  brain init              # Creates ~/brains/default
  brain init work         # Creates ~/brains/work

Structure created:
  ~/brains/<name>/
  ├── 00_inbox.md
  ├── 01_active/
  ├── 02_areas/
  ├── 03_resources/
  └── 99_archive/
EOF
}

# Parse arguments
BRAIN_NAME=""

if [[ $# -gt 0 ]]; then
    if [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]]; then
        show_help
        exit 0
    fi
    BRAIN_NAME="$1"
else
    BRAIN_NAME="default"
fi

# Validate brain name
if [[ ! "$BRAIN_NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    echo "Error: Brain name can only contain letters, numbers, hyphens, and underscores"
    exit 1
fi

# Check if brain already exists in config
if brain_exists "$BRAIN_NAME"; then
    EXISTING_PATH=$(get_brain_path "$BRAIN_NAME")
    if [[ -d "$EXISTING_PATH" ]]; then
        echo "Error: Brain '$BRAIN_NAME' already configured and exists."
        echo "Location: $EXISTING_PATH"
        echo "Use 'brain switch $BRAIN_NAME' to activate it."
        exit 1
    else
        echo "Warning: Brain '$BRAIN_NAME' is registered in config but missing on disk."
        echo "Repairing/Re-initializing at standardized location..."
        # Proceed to re-create
    fi
fi

# Define standardized location base
BRAIN_ROOT="${BRAIN_ROOT:-$HOME/brains}"

# Check directory collision
LOCATION="$BRAIN_ROOT/$BRAIN_NAME"

if [[ -d "$LOCATION" ]] && [[ -n "$(ls -A "$LOCATION" 2>/dev/null)" ]]; then
    # Check if it looks like a brain (adoption/recovery)
    if [[ -d "$LOCATION/01_active" ]] && [[ -f "$LOCATION/00_dump.md" ]]; then
        echo "Found existing brain data at $LOCATION."
        echo "Adopting it into configuration..."
    else
        echo "Error: Directory $LOCATION exists and is not empty."
        exit 1
    fi
else
    # Create new
    echo "Initializing brain '$BRAIN_NAME' at $LOCATION..."
    mkdir -p "$LOCATION"/{01_active,02_areas,03_resources,99_archive}
    cat > "$LOCATION/00_dump.md" << 'EOF'
# Dump

Quick capture landing zone. Process with `brain refile`.

EOF
    echo "OK: Created directory structure"
fi

# Add to config
add_brain "$BRAIN_NAME" "$LOCATION"
echo "OK: Registered '$BRAIN_NAME'"

# Auto-switch if it's the first brain or requested
CURRENT=$(get_current_brain)
if [[ -z "$CURRENT" ]] || [[ "$BRAIN_NAME" == "default" ]]; then
    set_current_brain "$BRAIN_NAME"
    echo "OK: Set as current brain"
    echo "OK: Updated symlink $BRAIN_SYMLINK -> $LOCATION"
fi

echo ""
echo "Success! Brain '$BRAIN_NAME' is ready."