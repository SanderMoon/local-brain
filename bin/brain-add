#!/usr/bin/env bash

# brain-add: Capture items to dump
# Usage:
#   brain add "text"  - Quick task capture
#   brain add         - Editor mode for notes

set -euo pipefail

# Source config library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Locate and source library
if [[ -f "$(dirname "$SCRIPT_DIR")/lib/brain-config.sh" ]]; then
  source "$(dirname "$SCRIPT_DIR")/lib/brain-config.sh"
elif [[ -f "$(dirname "$SCRIPT_DIR")/lib/brain/brain-config.sh" ]]; then
  source "$(dirname "$SCRIPT_DIR")/lib/brain/brain-config.sh"
elif [[ -f "$HOME/.config/brain/lib/brain-config.sh" ]]; then
  source "$HOME/.config/brain/lib/brain-config.sh"
else
  echo "Error: brain-config.sh library not found." >&2
  exit 1
fi

BRAIN_PATH=$(get_current_brain_path)
DUMP="$BRAIN_PATH/00_dump.md"

show_help() {
    cat << 'EOF'
brain-add - Capture items to dump

Usage:
  brain add "text"     Quick task capture (one-liner)
  brain add            Editor mode for notes (multi-line)

Quick capture appends a task to the dump:
  - [ ] your text #captured:2024-01-21

Editor mode opens a temp file for writing notes. On close,
the content is appended to dump as an indented note block:
  [Note] Title #captured:2024-01-21
      Your note content here...
      Multiple lines supported.

Examples:
  brain add "Fix the authentication bug"
  brain add "Email Sarah about proposal"
  brain add                              # Opens editor for meeting notes

Process dump items with: brain refile
EOF
}

# Check for help flag
if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    show_help
    exit 0
fi

# Ensure dump exists
if [[ ! -f "$DUMP" ]]; then
    echo "Error: Dump not found at $DUMP"
    echo "Run install.sh first or create the file manually"
    exit 1
fi

# Simple lock mechanism for concurrent access
acquire_lock() {
    local lock_dir="$BRAIN_PATH/.dump.lock"
    local max_retries=5
    local retry_delay=1

    for ((i=0; i<max_retries; i++)); do
        if mkdir "$lock_dir" 2>/dev/null; then
            return 0
        fi
        sleep "$retry_delay"
    done

    echo "Error: Could not acquire lock for dump (is another process writing?)"
    exit 1
}

release_lock() {
    local lock_dir="$BRAIN_PATH/.dump.lock"
    rmdir "$lock_dir" 2>/dev/null || true
}

# Quick capture mode: brain add "text"
if [[ $# -gt 0 ]]; then
    TIMESTAMP=$(date +"%Y-%m-%d")
    TEXT="$*"

    acquire_lock
    echo "- [ ] $TEXT #captured:$TIMESTAMP" >> "$DUMP"
    release_lock

    echo "OK: Added task to dump"
    exit 0
fi

# Editor mode: brain add (no args)
# Creates a note via temp file

# Prompt for title
read -r -p "Note title: " TITLE
if [[ -z "$TITLE" ]]; then
    echo "Aborted (no title)"
    exit 0
fi

# Create temp file
TEMP_FILE=$(mktemp)
trap "rm -f '$TEMP_FILE'" EXIT

# Add a helpful header comment (will be stripped)
cat > "$TEMP_FILE" << EOF
# Write your note below. This line will be removed.
# Save and close the editor when done.

EOF

# Open editor
if command -v nvim &> /dev/null; then
    nvim "+4" "$TEMP_FILE"
elif command -v vim &> /dev/null; then
    vim "+4" "$TEMP_FILE"
elif [[ -n "${EDITOR:-}" ]]; then
    $EDITOR "$TEMP_FILE"
else
    echo "Error: No editor found (tried nvim, vim, \$EDITOR)"
    exit 1
fi

# Read content, strip comment lines
CONTENT=$(grep -v '^#' "$TEMP_FILE" | sed '/^[[:space:]]*$/d' || true)

if [[ -z "$CONTENT" ]]; then
    echo "Aborted (empty note)"
    exit 0
fi

# Format as indented note block and append to dump
TIMESTAMP=$(date +"%Y-%m-%d")

acquire_lock

# Append note header
echo "[Note] $TITLE #captured:$TIMESTAMP" >> "$DUMP"

# Append indented content
echo "$CONTENT" | while IFS= read -r line; do
    echo "    $line" >> "$DUMP"
done

release_lock

echo "OK: Added note to dump"
