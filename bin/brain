#!/usr/bin/env bash

# Main dispatcher for Local Brain CLI
# Routes 'brain <command>' to 'brain-<command>'

set -euo pipefail

# Resolve script directory to find sibling commands (robust for local usage)
SELF_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

show_help() {
    cat << 'EOF'
Local Brain - CLI-based Project Management

Usage: brain <command> [options]

Brain Management:
  new [name]       Create a new brain (Alias: init)
  switch           Switch between configured brains
  ls, list         List all configured brains
  current          Show current active brain
  path             Show path to current or specified brain
  rename           Rename a brain
  delete           Permanently delete a brain
  import           Import existing brains

Commands:
  add [text]       Capture note to dump (quick or interactive)
  dump             Inspect dump contents (ls, ls --json)
  projects         List all active projects (Alias for 'project list')
  todo             View all open tasks across projects
  refile           Process dump items to projects (interactive or by ID)
  go               Jump to a project directory
  project          Manage projects (new, link, pull, archive, move, clone)
  sync             Control Syncthing sync operations

Examples:
  brain new                        # Create a new brain
  brain dump ls --json             # List dump items as JSON
  brain refile a1b2c3 my-project   # Refile item by ID (non-interactive)
  brain project clone <url>        # Import a project from git
  brain projects                   # List all active projects
  brain projects ls --json         # List projects as JSON
  brain switch work                # Switch to work brain

For more information on each command, run: brain <command> --help

Documentation: See ~/brain structure
EOF
}

# Get the command (first argument)
CMD="${1:-}"

# If no command or help flag, show help
if [[ -z "$CMD" ]] || [[ "$CMD" == "help" ]] || [[ "$CMD" == "--help" ]] || [[ "$CMD" == "-h" ]]; then
    show_help
    exit 0
fi

# Special alias handling
if [[ "$CMD" == "projects" ]]; then
    shift  # Remove 'projects' from arguments
    if [[ -x "$SELF_DIR/brain-project" ]]; then
        exec "$SELF_DIR/brain-project" list "$@"
    else
        exec brain-project list "$@"
    fi
fi

# Alias 'init' to 'new'
if [[ "$CMD" == "init" ]]; then
    if [[ -x "$SELF_DIR/brain-new" ]]; then
        exec "$SELF_DIR/brain-new" "$@"
    else
        exec brain-new "$@"
    fi
fi

# Alias 'ls' to 'list'
if [[ "$CMD" == "ls" ]]; then
    shift
    if [[ -x "$SELF_DIR/brain-list" ]]; then
        exec "$SELF_DIR/brain-list" "$@"
    else
        exec brain-list "$@"
    fi
fi

# Build full command name
FULL_CMD="brain-$CMD"

# Check if command exists adjacent to this script
if [[ -x "$SELF_DIR/$FULL_CMD" ]]; then
  # Shift off the command name and pass remaining args
  shift
  exec "$SELF_DIR/$FULL_CMD" "$@"
# Check if command exists in PATH
elif command -v "$FULL_CMD" &> /dev/null; then
  # Shift off the command name and pass remaining args
  shift
  exec "$FULL_CMD" "$@"
else
  echo "Error: Unknown command '$CMD'"
  echo ""
  echo "Available commands: new, switch, ls, list, current, path, rename, delete, import"
  echo "                    add, projects, todo, refile, go, project, sync"
  echo ""
  echo "Run 'brain help' for usage information"
  exit 1
fi
