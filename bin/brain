#!/usr/bin/env bash

# Main dispatcher for Local Brain CLI
# Routes 'brain <command>' to 'brain-<command>'

set -euo pipefail

# Resolve script directory to find sibling commands (robust for local usage)
SELF_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

show_help() {
    cat << 'EOF'
Local Brain - CLI-based Project Management

Usage: brain <command> [options]

Capture (to dump):
  add "text"       Quick task capture to dump
  add              Editor mode for notes (multi-line)

Process & Organize:
  dump ls          View dump contents
  refile           Process dump items → projects

Manage (in projects):
  todo             Browse/edit tasks (fzf picker)
  todo ls          List tasks across projects
  todo done        Mark task complete
  note             Browse/edit notes (fzf picker)
  note ls          List notes in focused project

Projects:
  project new      Create new project
  project focus    Set focused project
  projects         List all active projects
  go               Jump to project directory

Brain Management:
  new [name]       Create a new brain
  switch           Switch between brains
  ls, list         List all configured brains
  current          Show current active brain

Workflow:
  1. Capture:  brain add "task" / brain add (for notes)
  2. Process:  brain refile
  3. Work:     brain todo / brain note
  4. Complete: brain todo done

Examples:
  brain add "Fix the login bug"      # Quick task to dump
  brain add                          # Open editor for meeting notes
  brain refile                       # Process dump → projects
  brain todo ls                      # See all tasks
  brain todo done abc123             # Complete a task

For more info: brain <command> --help
EOF
}

# Get the command (first argument)
CMD="${1:-}"

# If no command or help flag, show help
if [[ -z "$CMD" ]] || [[ "$CMD" == "help" ]] || [[ "$CMD" == "--help" ]] || [[ "$CMD" == "-h" ]]; then
    show_help
    exit 0
fi

# Special alias handling
if [[ "$CMD" == "projects" ]]; then
    shift  # Remove 'projects' from arguments
    if [[ -x "$SELF_DIR/brain-project" ]]; then
        exec "$SELF_DIR/brain-project" list "$@"
    else
        exec brain-project list "$@"
    fi
fi

# Alias 'init' to 'new'
if [[ "$CMD" == "init" ]]; then
    if [[ -x "$SELF_DIR/brain-new" ]]; then
        exec "$SELF_DIR/brain-new" "$@"
    else
        exec brain-new "$@"
    fi
fi

# Alias 'ls' to 'list'
if [[ "$CMD" == "ls" ]]; then
    shift
    if [[ -x "$SELF_DIR/brain-list" ]]; then
        exec "$SELF_DIR/brain-list" "$@"
    else
        exec brain-list "$@"
    fi
fi

# Build full command name
FULL_CMD="brain-$CMD"

# Check if command exists adjacent to this script
if [[ -x "$SELF_DIR/$FULL_CMD" ]]; then
  # Shift off the command name and pass remaining args
  shift
  exec "$SELF_DIR/$FULL_CMD" "$@"
# Check if command exists in PATH
elif command -v "$FULL_CMD" &> /dev/null; then
  # Shift off the command name and pass remaining args
  shift
  exec "$FULL_CMD" "$@"
else
  echo "Error: Unknown command '$CMD'"
  echo ""
  echo "Available commands: new, switch, ls, list, current, path, rename, delete, import"
  echo "                    add, projects, todo, note, refile, go, project, sync"
  echo ""
  echo "Run 'brain help' for usage information"
  exit 1
fi
