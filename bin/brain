#!/usr/bin/env bash

# Main dispatcher for Local Brain CLI
# Routes 'brain <command>' to 'brain-<command>'

set -euo pipefail

# Resolve script directory to find sibling commands (robust for local usage)
SELF_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

show_help() {
  cat << 'EOF'
Local Brain - CLI-based Project Management

Usage: brain <command> [options]

Brain Management:
   init             Initialize a new brain location
   import [path]    Scan and register existing brains
   delete [name]    Permanently delete a brain
   switch           Switch between configured brains
 list       List all configured brains
 current     Show current active brain
 path       Show path to current or specified brain

Commands:

  add [text]       Capture note to inbox (quick or interactive)

  projects         Alias for 'project list'

  todo             View all open tasks across projects
 refile      Process inbox items to projects
 go        Jump to a project directory
   project          Manage projects (new, link, pull, archive)
   rename [old] [new] Rename a brain
   review           AI-powered project analysis (stub)
 sync       Control Syncthing sync operations

Examples:

  brain init                       # Initialize new brain (interactive)

  brain projects                   # List all active projects
 brain switch work        # Switch to work brain

For more information on each command, run: brain <command> --help

Documentation: See ~/brain structure
EOF
}

# Get the command (first argument)
CMD="${1:-}"

# If no command or help flag, show help
if [[ -z "$CMD" ]] || [[ "$CMD" == "help" ]] || [[ "$CMD" == "--help" ]] || [[ "$CMD" == "-h" ]]; then
  show_help
  exit 0
fi

# Special alias handling
if [[ "$CMD" == "projects" ]]; then
  if [[ -x "$SELF_DIR/brain-project" ]]; then
    exec "$SELF_DIR/brain-project" list
  else
    exec brain-project list
  fi
fi

# Build full command name
FULL_CMD="brain-$CMD"

# Check if command exists adjacent to this script
if [[ -x "$SELF_DIR/$FULL_CMD" ]]; then
  # Shift off the command name and pass remaining args
  shift
  exec "$SELF_DIR/$FULL_CMD" "$@"
# Check if command exists in PATH
elif command -v "$FULL_CMD" &> /dev/null; then
  # Shift off the command name and pass remaining args
  shift
  exec "$FULL_CMD" "$@"
else
  echo "Error: Unknown command '$CMD'"
  echo ""
  echo "Brain management: init, switch, list, current, path"
  echo "Available commands: add, clone, projects, todo, refile, go, project, review, sync"
  echo ""
  echo "Run 'brain help' for usage information"
  exit 1
fi