#!/usr/bin/env bash

# brain-note: Manage notes in projects
# Notes are stored as separate files in project/notes/ directory

set -euo pipefail

# Source config library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Locate and source library
if [[ -f "$(dirname "$SCRIPT_DIR")/lib/brain-config.sh" ]]; then
  source "$(dirname "$SCRIPT_DIR")/lib/brain-config.sh"
elif [[ -f "$(dirname "$SCRIPT_DIR")/lib/brain/brain-config.sh" ]]; then
  source "$(dirname "$SCRIPT_DIR")/lib/brain/brain-config.sh"
elif [[ -f "$HOME/.config/brain/lib/brain-config.sh" ]]; then
  source "$HOME/.config/brain/lib/brain-config.sh"
else
  echo "Error: brain-config.sh library not found." >&2
  exit 1
fi

BRAIN_PATH=$(get_current_brain_path)
ACTIVE_DIR="$BRAIN_PATH/01_active"

show_help() {
  cat << 'EOF'
brain-note - Manage notes in projects

Usage:
  brain note               Select and edit a note (fzf picker)
  brain note ls [--json]   List all notes in focused project
  brain note delete        Select and delete a note

Notes are stored as separate files in project/notes/ directory.
To create new notes, use: brain add (editor mode) → brain refile

Examples:
  brain note               # Pick a note to edit
  brain note ls            # List all notes
  brain note ls --json     # List notes as JSON
  brain note delete        # Pick a note to delete

Requires a focused project. Set with: brain project focus <name>
EOF
}

# Get focused project path
get_focused_project_path() {
  local focused=$(get_focused_project)
  if [[ -z "$focused" ]]; then
    echo "Error: No focused project. Set one with: brain project focus <name>" >&2
    return 1
  fi

  local project_path="$ACTIVE_DIR/$focused"
  if [[ ! -d "$project_path" ]]; then
    echo "Error: Project directory not found: $project_path" >&2
    return 1
  fi

  echo "$project_path"
}

# Edit note (default command) - fzf picker
cmd_edit() {
  local project_dir
  project_dir=$(get_focused_project_path) || exit 1

  local notes_dir="$project_dir/notes"

  if [[ ! -d "$notes_dir" ]]; then
    echo "No notes found in project"
    echo "Create notes with: brain add → brain refile"
    exit 0
  fi

  # Check for notes
  local notes_count=$(find "$notes_dir" -maxdepth 1 -name "*.md" 2>/dev/null | wc -l)
  if [[ "$notes_count" -eq 0 ]]; then
    echo "No notes found in project"
    echo "Create notes with: brain add → brain refile"
    exit 0
  fi

  # Check for fzf
  if ! command -v fzf &> /dev/null; then
    echo "Error: fzf not found"
    exit 1
  fi

  # Build preview command
  local preview_cmd
  if command -v bat &> /dev/null; then
    preview_cmd="bat --color=always --style=header,numbers '$notes_dir'/\$(echo {} | cut -d' ' -f1)"
  else
    preview_cmd="head -30 '$notes_dir'/\$(echo {} | cut -d' ' -f1)"
  fi

  # List notes with title preview, sorted by date (newest first)
  local selected
  selected=$(ls -1t "$notes_dir"/*.md 2>/dev/null | while read -r f; do
    local name=$(basename "$f")
    local title=$(head -1 "$f" | sed 's/^# //')
    printf "%-35s  %s\n" "$name" "$title"
  done | fzf --preview "$preview_cmd" \
             --header "Select note to edit (Esc to cancel)" \
             --preview-window 'right:60%' || true)

  if [[ -z "$selected" ]]; then
    exit 0
  fi

  # Extract filename from selection
  local filename=$(echo "$selected" | awk '{print $1}')

  if command -v nvim &> /dev/null; then
    nvim "$notes_dir/$filename"
  else
    vim "$notes_dir/$filename"
  fi
}

# List notes
cmd_ls() {
  local json_mode=false
  [[ "${1:-}" == "--json" ]] && json_mode=true

  local project_dir
  project_dir=$(get_focused_project_path) || exit 1

  local notes_dir="$project_dir/notes"

  if [[ ! -d "$notes_dir" ]]; then
    if [[ "$json_mode" == "true" ]]; then
      echo "[]"
    else
      echo "No notes found"
    fi
    exit 0
  fi

  if [[ "$json_mode" == "true" ]]; then
    # JSON output using jq -s
    for f in "$notes_dir"/*.md; do
      [[ ! -f "$f" ]] && continue

      local name=$(basename "$f" .md)
      local title=$(head -1 "$f" | sed 's/^# //')
      local created=""

      # Extract date from filename or Created: line
      if [[ "$name" =~ ^([0-9]{4}-[0-9]{2}-[0-9]{2})- ]]; then
        created="${BASH_REMATCH[1]}"
      else
        created=$(grep -m1 "^Created:" "$f" | sed 's/Created: //' || true)
      fi

      jq -n \
        --arg name "$name" \
        --arg title "$title" \
        --arg path "$f" \
        --arg created "$created" \
        '{name: $name, title: $title, path: $path, created: $created}'
    done | jq -s '.'
  else
    # Human-readable list
    local found=false
    for f in $(ls -1t "$notes_dir"/*.md 2>/dev/null); do
      found=true
      local name=$(basename "$f" .md)
      local title=$(head -1 "$f" | sed 's/^# //')
      printf "%-35s  %s\n" "$name" "$title"
    done

    if [[ "$found" == "false" ]]; then
      echo "No notes found"
    fi
  fi
}

# Delete note
cmd_delete() {
  local project_dir
  project_dir=$(get_focused_project_path) || exit 1

  local notes_dir="$project_dir/notes"

  if [[ ! -d "$notes_dir" ]]; then
    echo "No notes found in project"
    exit 0
  fi

  # Check for notes
  local notes_count=$(find "$notes_dir" -maxdepth 1 -name "*.md" 2>/dev/null | wc -l)
  if [[ "$notes_count" -eq 0 ]]; then
    echo "No notes found in project"
    exit 0
  fi

  # Check for fzf
  if ! command -v fzf &> /dev/null; then
    echo "Error: fzf not found"
    exit 1
  fi

  # Build preview command
  local preview_cmd
  if command -v bat &> /dev/null; then
    preview_cmd="bat --color=always --style=header,numbers '$notes_dir'/\$(echo {} | cut -d' ' -f1)"
  else
    preview_cmd="head -30 '$notes_dir'/\$(echo {} | cut -d' ' -f1)"
  fi

  # List notes for selection
  local selected
  selected=$(ls -1t "$notes_dir"/*.md 2>/dev/null | while read -r f; do
    local name=$(basename "$f")
    local title=$(head -1 "$f" | sed 's/^# //')
    printf "%-35s  %s\n" "$name" "$title"
  done | fzf --preview "$preview_cmd" \
             --header "Select note to DELETE (Esc to cancel)" \
             --preview-window 'right:60%' || true)

  if [[ -z "$selected" ]]; then
    exit 0
  fi

  # Extract filename
  local filename=$(echo "$selected" | awk '{print $1}')
  local filepath="$notes_dir/$filename"

  # Confirmation
  echo "About to delete: $filename"
  read -r -p "Are you sure? [y/N] " confirm
  case "$confirm" in
    [yY]|[yY][eE][sS])
      rm "$filepath"
      echo "OK: Deleted $filename"
      ;;
    *)
      echo "Cancelled"
      ;;
  esac
}

# Check for help flag
if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
  show_help
  exit 0
fi

# Command router
case "${1:-}" in
  ls|list)
    shift
    cmd_ls "$@"
    ;;
  delete|rm)
    shift
    cmd_delete "$@"
    ;;
  *)
    # Default: edit picker
    cmd_edit
    ;;
esac
