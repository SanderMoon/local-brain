#!/usr/bin/env bash

# brain-rename: Rename an existing brain
# Usage: brain rename <old-name> <new-name>

set -euo pipefail

# Source config library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Resolve library path robustly
if [[ -f "$(dirname "$SCRIPT_DIR")/lib/brain-config.sh" ]]; then
    source "$(dirname "$SCRIPT_DIR")/lib/brain-config.sh"
elif [[ -f "$(dirname "$SCRIPT_DIR")/lib/brain/brain-config.sh" ]]; then
    source "$(dirname "$SCRIPT_DIR")/lib/brain/brain-config.sh"
elif [[ -f "$HOME/.config/brain/lib/brain-config.sh" ]]; then
    source "$HOME/.config/brain/lib/brain-config.sh"
else
    echo "Error: brain-config.sh library not found." >&2
    exit 1
fi

show_help() {
    cat << 'EOF'
brain-rename - Rename an existing brain

Usage:
  brain rename <old-name> <new-name>

Examples:
  brain rename work old-work
  brain rename default personal

What it does:
  1. Renames the directory in ~/brains/
  2. Updates ~/.config/brain/config.json
  3. Updates ~/brain symlink if active
EOF
}

# Check args
if [[ $# -lt 2 ]] || [[ "$1" == "--help" ]]; then
    show_help
    exit 0
fi

OLD_NAME="$1"
NEW_NAME="$2"

# Validate names
if ! brain_exists "$OLD_NAME"; then
    echo "Error: Brain '$OLD_NAME' does not exist."
    exit 1
fi

if brain_exists "$NEW_NAME"; then
    echo "Error: Brain '$NEW_NAME' already exists."
    exit 1
fi

if [[ ! "$NEW_NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    echo "Error: New name contains invalid characters. Use alphanumerics, hyphens, underscores."
    exit 1
fi

OLD_PATH=$(get_brain_path "$OLD_NAME")
# Assuming standard structure ~/brains/name, we can deduce parent
# But let's handle cases where user might have init'd elsewhere safely
PARENT_DIR=$(dirname "$OLD_PATH")
NEW_PATH="$PARENT_DIR/$NEW_NAME"

if [[ -d "$NEW_PATH" ]]; then
    echo "Error: Target directory '$NEW_PATH' already exists."
    exit 1
fi

echo "Renaming '$OLD_NAME' to '$NEW_NAME'..."

# 1. Move Directory
mv "$OLD_PATH" "$NEW_PATH"
echo "OK: Moved directory to $NEW_PATH"

# 2. Update Config
rename_brain_config "$OLD_NAME" "$NEW_NAME" "$NEW_PATH"
echo "OK: Updated configuration"

# 3. Update Symlink if necessary
CURRENT_BRAIN=$(get_current_brain)
if [[ "$CURRENT_BRAIN" == "$NEW_NAME" ]]; then
    update_brain_symlink "$NEW_NAME"
    echo "OK: Updated active symlink"
fi

echo ""
echo "Success! Brain renamed."
